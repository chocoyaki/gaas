#!/bin/sh
#****************************************************************************#
#* Manager of a CORBA name server.                                          *#
#*                                                                          *#
#*  Author(s):                                                              *#
#*    - Philippe COMBES (Philippe.Combes@ens-lyon.fr)                       *#
#*                                                                          *#
#* $LICENSE$                                                                *#
#****************************************************************************#
#* $Id$
#* $Log$
#* Revision 1.3  2003/11/26 15:51:33  cpera
#* Add ps command line argument "-wwww" in order to get all process name when
#* its lenght is larger than 80 characters.
#*
#* Revision 1.2  2003/09/26 14:05:39  pcombes
#* Local platform scripts are managed by configure.
#*
#* Revision 1.1  2003/09/22 21:09:08  pcombes
#* Scripts for managing a local platform with LDAP + NWS + CORBA Name server.
#****************************************************************************#

# FIXME: this should be independent from the ORB or at least 

omni_start() {
  echo "## Starting a local CORBA name server ..."
  processes=`ps -edfwwwww | grep omniNames | tr '\n' '@'`
  nb_processes=`echo $processes | tr '@' '\n' | grep omniNames | wc -l`
  if [ "$processes" = "" -o \
       \( "$nb_processes" -eq 1 -a "`echo $processes | grep 'grep'`" != "" \) ]
  then
    if [ -f $LOGDIR/omninames-`hostname`.log \
         -o -f $LOGDIR/omninames-`hostname`.bak ]; then
      $OMNINAMES &
    else
      $OMNINAMES -start &
    fi
  else
    echo "Error: a CORBA name server may have already been started."
    exit 3
  fi
  echo "## CORBA name server started."
}

omni_stop() {
  echo "## Stopping the local CORBA name server ..."
  pprocess=`ps -wwwww -u $USER | grep omniNames | sort | head -1`
  if [ -n "$pprocess" -a "`echo $pprocess | grep 'grep omniNames'`" = "" ]; then
    pid=`echo $pprocess | cut -f1 -d' '`
    kill $pid > /dev/null 2>&1
    status=$?
    if [ $status -ne 0 ]; then
      echo "Error: cannot stop the CORBA name server."
      exit 3
    fi
  fi
  echo "## CORBA name server stopped."
}

omninames_test() {
  if [ "`ps -edfwwwww | grep omniNames`" = "" ]; then
    echo "No CORBA name server seems alive."
  else
    echo "There is a CORBA name server running. I cannot guess its port (normal)."
  fi
}


if [ "`echo @OMNIORB_HOME@ | cut -c1`" != "@" ]; then

  OMNINAMES=@OMNIORB_HOME@/bin/omniNames
  BINDIR=`dirname $0`
  LOGDIR=`cd $BINDIR/..; pwd`/var/log
  if [ ! -d $LOGDIR ]; then mkdir -p $LOGDIR; fi
  export OMNINAMES_LOGDIR=$LOGDIR
 
  case "$1" in 
    start) omni_start;;
    stop)  omni_stop;;
    test)  omninames_test;;
    *) echo "$0 {start|stop|test}"; exit 3;;
  esac

#elif ...
# FIXME: The code for another ORB should take place here.

fi
